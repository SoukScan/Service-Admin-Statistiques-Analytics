name: CD ‚Äì Admin Moderation Service (Dev)

on:
  workflow_dispatch:
  push:
    branches: [ "dev" ]

permissions:
  contents: read
  packages: read
  security-events: write
  actions: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
    # =====================================================
    # 1Ô∏è‚É£ Checkout
    # =====================================================
    - uses: actions/checkout@v4

    # =====================================================
    # 2Ô∏è‚É£ GHCR Image
    # =====================================================
    - name: Set GHCR image
      run: |
        echo "GHCR_IMAGE=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/admin-moderation-backend:ci-${{ github.sha }}" >> $GITHUB_ENV

    # =====================================================
    # 3Ô∏è‚É£ Minikube
    # =====================================================
    - name: Setup Minikube
      uses: medyagh/setup-minikube@latest

    - name: Start Minikube
      run: |
        minikube start --memory=4096 --cpus=2 --wait=all
        minikube addons enable ingress

    # =====================================================
    # 4Ô∏è‚É£ Helm
    # =====================================================
    - name: Install Helm
      run: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update

    # =====================================================
    # 5Ô∏è‚É£ PostgreSQL (BLOQUANT)
    # =====================================================
    - name: Install PostgreSQL
      run: |
        helm install postgres bitnami/postgresql \
          --set auth.username=admin \
          --set auth.password=adminpass \
          --set auth.database=adminmod \
          --set primary.persistence.enabled=false \
          --wait \
          --timeout 5m

    - name: Wait PostgreSQL
      run: |
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/instance=postgres \
          --timeout=180s

    # =====================================================
    # 6Ô∏è‚É£ Kafka (NON BLOQUANT ‚Äì CI SAFE)
    # =====================================================
    - name: Install Kafka (non-blocking)
      run: |
        helm install kafka bitnami/kafka \
          --set image.registry=ghcr.io \
          --set image.repository=bitnami/kafka \
          --set image.tag=4.0.0-debian-12-r10 \
          --set global.security.allowInsecureImages=true \
          --set kraft.enabled=true \
          --set controller.replicaCount=1 \
          --set replicaCount=0 \
          --set auth.enabled=false \
          --set persistence.enabled=false \
          --set resources.requests.cpu=100m \
          --set resources.requests.memory=256Mi

    # ‚ùå PAS DE --wait
    # ‚ùå PAS DE kubectl wait kafka

    # =====================================================
    # 7Ô∏è‚É£ GHCR Pull Secret
    # =====================================================
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Create GHCR pull secret
      run: |
        kubectl create secret docker-registry ghcr-pull-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GHCR_PAT }} \
          --docker-email=dev@example.com \
          --dry-run=client -o yaml | kubectl apply -f -

    # =====================================================
    # 8Ô∏è‚É£ Deploy Backend
    # =====================================================
    - name: Deploy backend
      run: |
        kubectl apply -f k8s/

         # CI-friendly: 1 replica only (minikube runner is small)
         kubectl scale deployment/admin-moderation-backend --replicas=1

         kubectl set image deployment/admin-moderation-backend \
          admin-moderation-backend=${{ env.GHCR_IMAGE }}

         kubectl rollout status deployment/admin-moderation-backend --timeout=300s

    - name: Debug backend pods (if needed)
      if: always()
      run: |
             kubectl get pods -l app=admin-moderation-backend -o wide
             kubectl describe pods -l app=admin-moderation-backend || true
             kubectl logs -l app=admin-moderation-backend --all-containers=true --tail=200 || true


    # =====================================================
    # 9Ô∏è‚É£ Observability (ELK)
    # =====================================================
    - name: Create observability namespace
      run: kubectl create namespace observability --dry-run=client -o yaml | kubectl apply -f -

    - name: Add ELK repos
      run: |
        helm repo add elastic https://helm.elastic.co
        helm repo add fluent https://fluent.github.io/helm-charts
        helm repo update

    - name: Install Elasticsearch
      run: |
        helm install elasticsearch elastic/elasticsearch \
          --namespace observability \
          --set replicas=1 \
          --set minimumMasterNodes=1 \
          --set resources.requests.cpu=250m \
          --set resources.requests.memory=512Mi \
          --wait \
          --timeout 10m

    - name: Install Kibana
      run: |
        helm install kibana elastic/kibana \
          --namespace observability \
          --wait \
          --timeout 5m

    - name: Install Fluent Bit
      run: |
        helm install fluent-bit fluent/fluent-bit \
          --namespace observability \
          --set backend.type=es \
          --set backend.es.host=elasticsearch-master \
          --set backend.es.port=9200 \
          --wait \
          --timeout 5m

    # =====================================================
    # üîü Port-forward Backend
    # =====================================================
    - name: Port forward backend
      run: |
        kubectl port-forward service/admin-moderation-backend-service 8090:8090 &
        echo $! > .pid
        sleep 10

    # =====================================================
    # 1Ô∏è‚É£1Ô∏è‚É£ Health Check
    # =====================================================
    - name: HTTP check
      run: |
        for i in {1..15}; do
          curl -sf http://localhost:8090/actuator/health && exit 0
          sleep 4
        done
        echo "Backend not reachable"
        kubectl get pods -o wide
        kubectl logs -l app=admin-moderation-backend
        exit 1

    # =====================================================
    # 1Ô∏è‚É£2Ô∏è‚É£ ZAP
    # =====================================================
    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: "http://localhost:8090/actuator/health"
      continue-on-error: true

    # =====================================================
    # 1Ô∏è‚É£3Ô∏è‚É£ Cleanup
    # =====================================================
    - name: Kill port-forward
      if: always()
      run: kill $(cat .pid) || true

