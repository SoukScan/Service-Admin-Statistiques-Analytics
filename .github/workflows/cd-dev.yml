name: CD â€“ Admin Moderation Service (Dev)

on:
  workflow_dispatch:
  push:
    branches: [ "dev" ]

permissions:
  contents: read
  packages: read
  security-events: write
  actions: read

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout
    - uses: actions/checkout@v4

    # 2ï¸âƒ£ Image GHCR
    - name: Set GHCR image
      run: |
        echo "GHCR_IMAGE=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')/admin-moderation-backend:ci-${{ github.sha }}" >> $GITHUB_ENV

    # 3ï¸âƒ£ Minikube
    - name: Setup Minikube
      uses: medyagh/setup-minikube@latest

    - name: Start Minikube
      run: |
        minikube start --memory=4096 --cpus=2 --wait=all
        minikube addons enable ingress

    # 4ï¸âƒ£ Helm
    - name: Install Helm
      run: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo update

    # 5ï¸âƒ£ PostgreSQL
    - name: Install PostgreSQL
      run: |
        helm install postgres bitnami/postgresql \
          --set auth.username=admin \
          --set auth.password=adminpass \
          --set auth.database=adminmod \
          --set primary.persistence.enabled=false \
          --wait \
          --timeout 5m

    - name: Wait PostgreSQL
      run: |
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/instance=postgres \
          --timeout=180s

    # 6ï¸âƒ£ Kafka (CORRIGÃ‰ â€“ GHCR + KRaft)
    - name: Install Kafka
      run: |
        helm install kafka bitnami/kafka \
          --set image.registry=ghcr.io \
          --set image.repository=bitnami/kafka \
          --set kraft.enabled=true \
          --set controller.replicaCount=1 \
          --set replicaCount=1 \
          --set auth.enabled=false \
          --set persistence.enabled=false \
          --wait \
          --timeout 10m

    - name: Wait Kafka
      run: |
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/instance=kafka \
          --timeout=300s

    # 7ï¸âƒ£ Login GHCR
    - name: Login GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_PAT }}

    - name: Use Minikube Docker
      run: eval $(minikube docker-env)

    - name: Create GHCR pull secret
      run: |
        kubectl create secret docker-registry ghcr-pull-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GHCR_PAT }} \
          --docker-email=dev@example.com \
          --dry-run=client -o yaml | kubectl apply -f -

    # 8ï¸âƒ£ Deploy backend
    - name: Deploy backend
      run: |
        kubectl apply -f k8s/
        kubectl set image deployment/admin-moderation-backend \
          admin-moderation-backend=${{ env.GHCR_IMAGE }}
        kubectl rollout status deployment/admin-moderation-backend --timeout=180s

    - name: Wait backend
      run: |
        kubectl wait --for=condition=ready pod \
          -l app=admin-moderation-backend \
          --timeout=180s

    # 9ï¸âƒ£ Observability (ELK)
    - name: Create observability namespace
      run: kubectl create namespace observability --dry-run=client -o yaml | kubectl apply -f -

    - name: Add ELK repos
      run: |
        helm repo add elastic https://helm.elastic.co
        helm repo add fluent https://fluent.github.io/helm-charts
        helm repo update

    - name: Install Elasticsearch
      run: |
        helm install elasticsearch elastic/elasticsearch \
          --namespace observability \
          --set replicas=1 \
          --set minimumMasterNodes=1 \
          --set resources.requests.cpu=250m \
          --set resources.requests.memory=512Mi \
          --wait \
          --timeout 10m

    - name: Install Kibana
      run: |
        helm install kibana elastic/kibana \
          --namespace observability \
          --wait \
          --timeout 5m

    - name: Install Fluent Bit
      run: |
        helm install fluent-bit fluent/fluent-bit \
          --namespace observability \
          --set backend.type=es \
          --set backend.es.host=elasticsearch-master \
          --set backend.es.port=9200 \
          --wait \
          --timeout 5m

    # ðŸ”Ÿ Port-forward backend
    - name: Port forward backend
      run: |
        kubectl port-forward service/admin-moderation-backend-service 8080:8080 &
        echo $! > .pid

